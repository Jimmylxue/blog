# å®ç°ä¸€ä¸ªé‚®ç®±è¾…åŠ©ç™»å½•åŠŸèƒ½

## ç—›ç‚¹

å¦‚æœæœ‰è‡ªå·±æŠ˜è…¾ä¸€äº›è‡ªå·±çš„ç½‘ç«™ï¼Œæˆ–è€…åšæ¯•è®¾çš„åŒå­¦ï¼Œç›¸ä¿¡ä½ ä»¬ä¸€å®šéƒ½é‡åˆ°è¿‡è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼šæ³¨å†Œæ—¶ï¼Œæƒ³ç”¨å¾®ä¿¡å·ã€æ‰‹æœºå·ã€é‚®ç®±æ¥è¾…åŠ©ç™»å½•ï¼Œä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆæ¥å…¥åˆ°æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œäº¦æˆ–æ˜¯è¦æ”¶è´¹ã€‚

> - æ¥å…¥å¾®ä¿¡å¼€æ”¾å¹³å°ç½‘é¡µç™»å½•æ”¶è´¹ã€‚
> - æ‰‹æœºå·çŸ­ä¿¡æœåŠ¡æ”¶è´¹ã€‚
> - **é‚®ä»¶æœåŠ¡ï¼Œæˆ‘ä»¬å³å¯è‡ªå·±å®ç°ã€‚**

æˆ‘å‰ååšäº†å¥½å‡ ä¸ªå°å·¥å…·æˆ–è€…ç½‘ç«™ï¼Œè¿™ä¸ªé—®é¢˜æŠ€æœ¯é—®é¢˜ä¸€ç›´æ²¡æœ‰è¢«çªç ´ï¼Œè¿‘æœŸç»ˆäºå®ç°äº†é‚®ç®±éªŒè¯ç ç³»ç»Ÿã€‚å¹¶æ¥å…¥äº† [DODD](https://tdl.jimmyxuexue.top/#/center) ä¸­ã€‚

## æ•ˆæœ

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20231212110242628](https://image.jimmyxuexue.top/img/202312121102770.png)

å¯¹åº”çš„é‚®ç®±ä¼šæ”¶åˆ°è¿™ä¹ˆä¸€æ¡ä¿¡æ¯ï¼š

![image-20231212110424010](https://image.jimmyxuexue.top/img/202312121104097.png)

![image-20231212110500300](https://image.jimmyxuexue.top/img/202312121105345.png)

å°†æ­¤éªŒè¯ç è¾“å…¥ä¹‹åï¼Œä¾¿å¯ç™»å½•ç³»ç»Ÿï¼Œè·å–å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ã€‚

## å®ç°æ€è·¯

ä¸‹é¢æˆ‘ä»¬æ¥è¯´è¯´å®ç°æ€è·¯ï¼Œæ•´ä½“ä¸Šæˆ‘ä»¬æ˜¯éœ€è¦è§£å†³è¿™ä¹ˆä¸¤ä¸ªé—®é¢˜ï¼š

- é€šè¿‡ä»£ç çš„æ–¹å¼å‘é€é‚®ä»¶ã€‚
- å°†éªŒè¯ç &å‘é€ç”¨æˆ·ä¸ç³»ç»Ÿè¿›è¡Œå…³è”ï¼Œè¿›è¡Œä¸€äº›æ ¡éªŒçš„é€»è¾‘ã€‚

### å‘é€é‚®ä»¶

ä¹‹å‰ B ç«™ä¸Šä¼ è¿‡ä¸€ä¸ªè§†é¢‘ï¼Œè®²äº†å¦‚ä½•å‘é€é‚®ä»¶ï¼Œé™„ä¸Šä¼ é€é—¨ ğŸšªï¼š[nodejs å®ç°é‚®ä»¶æœåŠ¡](https://www.bilibili.com/video/BV1Dz4y1G7wm/?vd_source=b869b9e47469b5438851429bda1fb3fc)

<iframe src="//player.bilibili.com/player.html?aid=576691965&bvid=BV1Dz4y1G7wm&cid=1285265826&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>

æ ¸å¿ƒå°±æ˜¯é€šè¿‡ [nodemailer](https://www.npmjs.com/package/nodemailer) è¿™ä¸ªåº“ï¼Œå»å¸®åŠ©æˆ‘ä»¬å‘é€ä¸€äº›é‚®ä»¶ã€‚

> è¿™ä¸ªåº“çš„æ ¸å¿ƒä¹Ÿæ˜¯å»è°ƒç”¨ä¸€äº›é‚®ç®±çš„å…¬å…±æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯éœ€è¦è·å–è‡ªå·±è´¦å·çš„ tokenï¼Œå¹¶ä¸”å¼€æ”¾ä¸€äº›é«˜çº§æƒé™çš„ã€‚

å…·ä½“çš„å¦‚ä½•æ“ä½œä¸åœ¨è¿™ç¯‡å†…å®¹åšè¯¦ç»†è®°å½•ï¼Œå¤§å®¶è‡ªè¡Œè¿‡ä¸€éè§†é¢‘å³å¯ã€‚

### ä¸ç°æœ‰ç³»ç»Ÿè¿›è¡Œå…³è”

> ä½œä¸ºä¸€åå‰ç«¯ç¨‹åºå‘˜ ğŸ‘¨ğŸ»â€ğŸ’»ï¼Œæ‰€ä»¥è¿™ä¸€å—çš„å®ç°å¯èƒ½ä¼šæœ‰å¹¶ä¸æ˜¯éå¸¸åˆç†çš„åœ°æ–¹ï¼Œè¿˜æœ›å¤§å®¶å¯ä»¥æå‡ºæ›´å¥½çš„æ–¹æ¡ˆã€‚

è¿™é‡Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©`redis`ï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨`redis`è€Œä¸ç”¨`mysql`æ˜¯å› ä¸ºå®ƒæ‹¥æœ‰æ›´å¿«çš„é€Ÿåº¦ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»´æŠ¤è¿™ä¹ˆä¸€ä¸ªæ•°æ®ç»“æ„ã€‚key ä¸ºï¼š`snow-server-mail-verification-code-é‚®ç®±åœ°å€`ï¼Œå€¼ä¸ºéšæœºå…­ä½æ•°éªŒè¯ç ã€‚åŒäº‹è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 10 åˆ†é’Ÿã€‚

> è®¾ç½®äº† 10 åˆ†é’Ÿåï¼Œredis ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬æ¸…ç©ºæ‰è¿™ä¸ª key

```ts
@Post('send_verification_code')
async send(@Body() body: SendMailDto) {
  const { mail } = body;
  if (!isQQMail(mail)) {
    return { code: 500, result: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡® - ä¸æ˜¯qqé‚®ç®±' };
  }
  const redis = await RedisInstance.initRedis();
  const code = generateRandomCode();
  const key = `snow-server-mail-verification-code-${mail}`;
  redis.set(key, code);
  redis.expire(key, 600); // å•ä½æ˜¯ç§’
  await this.nodemailerService.sendVerificationCode({ to: mail, code });
  return { code: 200, result: 'å‘é€æˆåŠŸ' };
}
```

è®¾ç½®ä¸Šäº†è¿™ä¹ˆä¸ª key ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™æ‹¿ä¸Šè¿™ä¸ªéªŒè¯ç å’Œ key æ ¡éªŒä¸€ä¸‹`redis`ä¸­è¿™ä¸ª key æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™æ ¡éªŒé€šè¿‡ï¼Œç»™äºç™»å½•çš„ token ä¹‹ç±»çš„æƒé™ã€‚

éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š

```ts
@Post('login_by_mail')
async loginByMail(@Body() body: LoginByMailDto) {
  const { code, mail } = body;
  if (!isQQMail(mail)) {
    return { code: 500, result: 'é‚®ç®±æ ¼å¼éªŒè¯å¼‚å¸¸ï¼Œè¯·æ ¡éªŒ' };
  }
  let user = await this.usersService.findUserByMail(mail);
  if (!user) {
    return {
      code: 10000,
      result: 'è¯¥é‚®ç®±æœªåˆ›å»ºç”¨æˆ·ï¼Œè¯·æ£€æŸ¥åœ°å€ï¼Œæˆ–ä¸ºè¯¥é‚®ç®±æ³¨å†Œä¸€ä¸ªç”¨æˆ·',
    };
  }
  const redis = await RedisInstance.initRedis();
  const key = `snow-server-mail-verification-code-${mail}`;
  const redisCode = await redis.get(key);
  if (redisCode !== code.toUpperCase()) {
    return {
      code: 500,
      result: 'éªŒè¯ç æ ¡éªŒå¤±è´¥ï¼Œè¯·é‡æ–°å‘é€éªŒè¯ç è¿›è¡Œæ ¡éªŒ',
    };
  }
  if (redisCode) {
    await redis.del(key);
  }
  return await this.usersService.createToken(user);
}
```

## æ€»ç»“

åŸºäºä»¥ä¸Šçš„ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨è‡ªå·±çš„ç³»ç»Ÿä¸­æ¥å…¥é‚®ç®±è¾…åŠ©ç™»å½•çš„æœåŠ¡äº†ã€‚å¯¹äºæƒ³è¦è‡ªå·±åŠ¨æ‰‹åšä¸€ä¸ªè‡ªå·±ç½‘ç«™ä¹‹ç±»çš„ä¸œè¥¿è¿˜æ˜¯æŒºä¸é”™çš„ã€‚

æ„Ÿè°¢è§‚çœ‹ã€‚æœ‰ä¸æ¸…æ™°çš„åœ°æ–¹æ¬¢è¿ç§ä¿¡ã€‚
