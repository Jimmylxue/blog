# Timer å®šæ—¶å™¨æµ‹è¯•

å®šæ—¶å™¨`setTimerout` æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ä¸ª apiï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦åœ¨ 1000ms ååšæŸä»¶äº‹æƒ…ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±ä¼šéœ€è¦ä½¿ç”¨è¿™ä¸ª apiï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•æµ‹è¯•è¿™ä¸ª apiã€‚

> è¿™èŠ‚ç®—æ˜¯è¿›é˜¶è¯¾ç¨‹å†…å®¹äº†ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ å‡ ä¸ªæ–°çš„ apiã€‚å­¦ä¹ å‡ ä¸ªæ–°çš„æµ‹è¯•æ€è·¯

## æ¡ˆä¾‹

ä¸¾ä¸ªä¾‹å­ ğŸŒ°ï¼Œæˆ‘ä»¬éœ€è¦ 4s åæ‰§è¡ŒæŸæ®µç¨‹åºã€‚ä»£ç å¦‚ä¸‹ï¼š

```ts
export function after4000ms(fn: (args: string) => string) {
	setTimeout(() => {
		fn('hello timer')
	}, 4000)
}
```

> å¾ˆçœ¼ç†Ÿæ˜¯å§ï¼Œå’Œæˆ‘ä»¬å‰ä¸€èŠ‚å­¦ä¹ å¼‚æ­¥å›è°ƒå‡½æ•°çš„ demo åŸºæœ¬ä¸€æ ·ã€‚
>
> ä½†æ˜¯é‚£æ—¶å€™æˆ‘ä»¬åªèƒ½å®ç°è¯´ç¡®å®çŸ¥é“æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“æ˜¯ä¸æ˜¯å…·ä½“çš„ 4000msã€‚

## ç¼–å†™å•æµ‹

### ä½¿ç”¨æ—§çŸ¥è¯†

çœ‹åˆ°è¿™ä¸ª demoï¼Œç¬¬ä¸€æƒ³æ³•å¤§å®¶ä¼šæ€æ ·ç¼–å†™æµ‹è¯•ç”¨ä¾‹å‘¢ï¼Ÿæˆ‘ç¬¬ä¸€æƒ³æ³•æ˜¯è¿™ä¹ˆå†™çš„ï¼š

```ts
it('ç¬¬ä¸€æƒ³æ³•', () => {
	const testFn = (str: string) => {
		expect(str).toBe('hello timer')
		return str
	}
	after4000ms(testFn)
})
```

æ‰§è¡Œè¿™ä¸ªå•æµ‹ä¹‹åå‘¢ï¼Œæ˜¯é€šè¿‡çš„ï¼Œä½†æ˜¯æ—¶é—´ä¸Šæ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚

![image-20230731111118088](https://image.jimmyxuexue.top/img/202307311111200.png)

è¿™ä¸ªå•æµ‹åªæ‰§è¡Œäº†å°äº 1s çš„æ—¶é—´ï¼Œå¹¶æ²¡æœ‰å®šæ—¶å™¨çš„æ¦‚å¿µã€‚æ‰€ä»¥è¿™ä¹ˆæµ‹è¯•æ˜¯ä¸å¯¹çš„ã€‚

ä¹‹å‰è®²å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´è¿‡æ¶‰åŠå¼‚æ­¥çš„å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `done` å‡½æ•°æ¥ç­‰å¾… timer ç»“æŸã€‚æ‰€ä»¥æˆ‘ä»¬åŸºäºè¿™ç‚¹çŸ¥è¯†ï¼Œæˆ‘ä»¬å†æ¥é‡æ„ä¸€ä¸‹æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ï¼š

```ts
it('ä½¿ç”¨ done æµ‹è¯•', done => {
	const testFn = (str: string) => {
		expect(str).toBe('hello timer')
		done()
		return str
	}
	after4000ms(testFn)
})
```

æˆ‘ä»¬è¿™æ ·æµ‹è¯•äº†ä¹‹åï¼Œç¨‹åºçš„æ‰§è¡Œæ—¶é—´å¥½åƒç¡®å®æ˜¯ä¹…äº†ï¼Œè¾“å‡ºçš„å†…å®¹å¦‚ä¸‹ï¼š
![image-20230731111559387](https://image.jimmyxuexue.top/img/202307311115434.png)

è€—æ—¶å°†è¿‘ 5sï¼Œçœ‹èµ·æ¥æ­£å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰çš„ç”µè„‘è®¾å¤‡ä»–æ¯”è¾ƒè€ï¼Œç®—åŠ›æ¯”è¾ƒä½ï¼Œå¯èƒ½æœ¬èº«çš„å®šæ—¶å™¨æ—¶é—´æ˜¯ 2sï¼Œä½†æ˜¯è„šæœ¬æ‰§è¡Œä¸‹æ¥èŠ±äº†å°†è¿‘ 5sï¼Œä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç¡®åˆ‡çš„çŸ¥é“å®ƒå›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚

æ‰€ä»¥æˆ‘ä»¬å¾—å†åšä¸€æ¬¡è°ƒæ•´ï¼š

```ts
it('æµ‹è¯•æ—¶é—´è¿‡äº† 1000ms', done => {
	const startTime = Date.now()
	const testFn = (str: string) => {
		const endTime = Date.now()
		expect(endTime - startTime > 4000).toBeTruthy()
		expect(str).toBe('hello timer')
		done()
		return str
	}
	after4000ms(testFn)
})
```

è¿™æ ·å†™äº†ä¹‹åï¼Œå†çœ‹è¾“å‡ºï¼Œä¹Ÿæ˜¯é€šè¿‡çš„ï¼Œæœ€é‡è¦çš„æ˜¯`expect(endTime - startTime > 4000).toBeTruthy()`ï¼Œè¯´æ˜æ‰§è¡Œæ—¶é—´ç¡®å®æ˜¯ 4s åã€‚

![image-20230731111916458](https://image.jimmyxuexue.top/img/202307311119494.png)

#### å­˜åœ¨çš„é—®é¢˜

çœ‹èµ·æ¥æˆ‘ä»¬å¥½åƒå·²ç»èƒ½å¤Ÿå¾ˆå®Œç¾çš„æµ‹è¯•äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°è¿™æ ·å†™æˆ‘ä»¬å¿…é¡»æ¯æ¬¡éƒ½ç­‰å¾…å®šæ—¶å™¨æ‰§è¡Œç»“æŸï¼Œå¦‚æœå®šæ—¶å™¨æ˜¯ 1min åæ‰§è¡Œï¼Œé‚£æˆ‘ä»¬ç¨‹åºå°±ä¼šç­‰å¾… 1minã€‚

> jest æœ¬èº«å¦‚æœç­‰å¾…æ—¶é—´è¶…è¿‡ 5s å°±ä¼šæŠ¥é”™äº†

æ‰€ä»¥ä»¥ä¸Šå¹¶ä¸æ˜¯æ­£ç¡®çš„è§£å†³æ€è·¯ã€‚jest å®è´¨ä¸Šæä¾›äº†ä¸“é—¨çš„ api ç”¨äºæˆ‘ä»¬æµ‹è¯•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹ã€‚

### å®˜ç½‘ä¼˜è§£

#### ä½¿ç”¨ mock çš„æ–¹æ¡ˆ

```ts
it('æ¨¡æ‹Ÿæ—¶é—´&æ¨¡æ‹Ÿapi', () => {
	jest.useFakeTimers()
	jest.spyOn(global, 'setTimeout')
	expect(setTimeout).toHaveBeenCalledTimes(0)
	after4000ms(() => 'demo')
	expect(setTimeout).toHaveBeenCalledTimes(1) // æ‰§è¡Œ1æ¬¡
	expect(setTimeout).toHaveBeenCalledWith(expect.any(Function), 4000) // 4000msè°ƒç”¨
})
```

- useFakeTimer()

  ä½¿ç”¨ä¼ªé€ çš„æ—¶é—´

- spyOn

  æ¨¡æ‹Ÿ api

> è¿™äº› api å…¶å®æˆ‘ä»¬çœ‹åå­—å°±èƒ½çŸ¥é“å¯¹åº”çš„æ„æ€ï¼Œfakeï¼ˆä¼ªé€ çš„ï¼‰ï¼Œspyï¼ˆé—´è°ï¼‰

æ ¸å¿ƒæ€è·¯:

æˆ‘ä»¬`after4000ms`è¿™ä¸ªå‡½æ•°æ˜¯ä½¿ç”¨ `setTimerout` æ¥å®ç°çš„ï¼Œæˆ‘ä»¬æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­`setTimerout`çš„æ‰§è¡Œæ¬¡æ•°å’Œæ‰§è¡Œæ—¶é—´å°±å¯ä»¥äº†ã€‚

#### ç»§ç»­ä¼˜åŒ–

ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬åªæ˜¯ç›‘å¬äº†`setTimerout`çš„æ‰§è¡Œæ¬¡æ•°ï¼Œå¦‚æœå•æµ‹å†…æœ¬èº«å°±æœ‰å†™äº†`setTimerout`ï¼Œé‚£è¿™æ ·å†™å°±ä¸å‡†äº†ï¼Œä¹Ÿä¼šå¢åŠ ä¸€äº›å¿ƒæ™ºè´Ÿæ‹…ï¼Œæˆ‘ä»¬æˆ‘ä»¬è¦å‡†ç¡®çš„çŸ¥é“ä¸€ä¸ªå‡½æ•°æ˜¯å¦è¢«è°ƒç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`jest.fn()` åˆ›å»ºä¸€ä¸ª mock å‡½æ•°

```ts
it('1000msåå‡½æ•°ç¡®å®è¢«è°ƒç”¨äº†', () => {
	jest.useFakeTimers()
	jest.spyOn(global, 'setTimeout')
	const fn = jest.fn()
	after4000ms(fn)
	expect(fn).toHaveBeenCalledTimes(0) // fn å‡½æ•°è¢«è°ƒç”¨0æ¬¡
	jest.runAllTimers()
	expect(setTimeout).toHaveBeenCalledTimes(1) // fn å‡½æ•°è¢«è°ƒç”¨1æ¬¡
	expect(setTimeout).toHaveBeenCalledWith(expect.any(Function), 4000)
})
```

- Jest.fn

  æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª api æ¥ mock ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°æˆ‘ä¹ˆå¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°çš„å¾ˆå¤šä¿¡æ¯ï¼Œå¦‚æ˜¯å¦è¢«è°ƒç”¨ç­‰ç­‰ã€‚

- jest.runAllTimers()

  ç›¸å½“äºå¿«è¿›æ—¶é—´ã€‚

## æ€»ç»“

è¿™èŠ‚å…³äºå®šæ—¶å™¨çš„å•æµ‹ç”¨ä¾‹ç¼–å†™å†…å®¹å°±åˆ°è¿™é‡Œäº†ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯å­¦ä¹ äº†å‡ ä¸ªæ–°çš„ apiï¼š

- useFakeTime
- spyOn
- fn
- runAllTimers

ä»¥ä¸Šçš„å†…å®¹å¤§å®¶éœ€è¦è‡ªè¡Œè¯¾åå®ç°ä¸€æ¬¡ï¼Œæ›´èƒ½åŠ æ·±ç†è§£ã€‚
