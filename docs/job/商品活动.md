# å°ç¨‹åºå•†å“æ´»åŠ¨é‡‘é¢è®¡ç®—

## æ ¸å¿ƒæµç¨‹

å°ç¨‹åºè¿›å…¥é¢„ä¸‹å•é¡µé¢ä¹‹å‰ï¼Œæ¶‰åŠçš„æ‰€æœ‰é‡‘é¢çš„è®¡ç®—å‡æœ‰å‰ç«¯è¿›è¡Œè®¡ç®—ã€‚

è¿›å…¥é¢„ä¸‹å•é¡µé¢ä¹‹åçš„é‡‘é¢ç”±åç«¯çš„`preAddOrder`æ¥å£è®¡ç®—ã€‚æ¥å£è¿”å›ä¸ä¸Šä¸€æœŸ[pos æ”¯ä»˜](https://517tastien.feishu.cn/wiki/H3XpwgEnRixdAxk04PlcsWornRd)çš„å†…å®¹æ˜¯ä¸€è‡´çš„ã€‚ è¿™å—ä¸æ˜¯æœ¬æ¬¡æ ¸å¿ƒè®¨è®ºç‚¹ã€‚

### ä¸ºä»€ä¹ˆè¦å¦‚æ­¤è®¾è®¡

- å°‘è°ƒç”¨å‡ æ¬¡æ¥å£ï¼Œå‡è½»åç«¯å‹åŠ›

  å¦‚æœæ”¾åœ¨åç«¯è®¡ç®—ï¼Œé‚£ä¹ˆæ¯æ¬¡è´­ç‰©è½¦å˜åŠ¨ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡æ¥å£ï¼Œé€ æˆçš„è¯·æ±‚æ•°é‡å°†æ˜¯æˆæŒ‡æ•°çº§åˆ«çš„ä¸Šå‡ï¼Œæ ¹æœ¬é¡¶ä¸ä½ã€‚

- èƒ½å¤Ÿè®©é¡µé¢æ“ä½œæ›´åŠ æµç¨‹

  å¦‚æœæ¯æ¬¡è´­ç‰©è½¦å˜åŠ¨éƒ½éœ€è¦ç­‰å¾…å‡ ç™¾æ¯«ç§’æ‰èƒ½è®¡ç®—å‡ºä»·æ ¼ï¼Œæ•´ä¸ªæ“ä½œæµç¨‹æ˜¯éå¸¸å¡é¡¿å’Œæœ‰å‰²è£‚æ„Ÿçš„ã€‚æ”¾å‰ç«¯è®¡ç®—èƒ½å¤Ÿè®©ç”¨æˆ·åœ¨æ“ä½œçš„æ—¶å€™æ›´åŠ ä¸æ»‘ã€‚

### app å’Œ å°ç¨‹åºä¸‹å•æµç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œapp ä¸ºä»€ä¹ˆä¸é‡‡ç”¨è¿™ç§æ¨¡å¼

- app ä½“é‡è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå°ï¼Œå…¨å›½å°±å‡ åƒå®¶é—¨åº—ï¼Œæ¥å£å®Œå…¨é¡¶å¾—ä½ã€‚

- ç»´æŠ¤æˆæœ¬å˜é«˜ï¼Œä¸€æ—¦é€»è¾‘å˜æ›´ï¼Œéœ€è¦ä¸¤ç«¯çš„å¼€å‘åŒå­¦ä¸€èµ·åŒæ­¥æ›´è¿›ç»´æŠ¤ï¼Œåœ¨ä½“é‡å°çš„æƒ…å†µä¸‹ï¼Œæ¶å¿ƒçš„äº‹æƒ…ä¸€ä¸ªäººåšå°±å¥½äº†ã€‚

- éƒ½æ˜¯è‡ªå·±äººï¼Œä¸‹å•çš„æµç¨‹é‡‘é¢å‡ºç°çš„æ…¢ä¸€ç‚¹æ²¡äº‹ã€‚

## å•†å“æ´»åŠ¨ç±»å‹

å•†å“æ´»åŠ¨ä¸»è¦æœ‰æ˜¯ä¸‰ç§ï¼š

> åç»­ CodeReview ä¸»è¦ä¹Ÿé’ˆå¯¹è¿™å—ä»£ç è¿›è¡Œ CodeReview

- é™æ—¶æŠ˜æ‰£ `STRAIGHT_AT`

  > æ²¡æœ‰ä»»ä½•é—¨æ§›ï¼Œå¥½æ¯”äºä¸€ä¸ªç‰¹ä»· 6 å…ƒæ±‰å ¡ ğŸ”ï¼Œç›´æ¥è´­ä¹°å°±æ˜¯ 6 å…ƒã€‚

  ğŸŒ°ï¼š

  åªè¦è´­ç‰©è½¦æœ‰è¿™ä¸ª ğŸ”ï¼Œä»·æ ¼å‡ä»¥ 6 å…ƒè¿›è¡Œè®¡ç®—

- æ»¡å‡æŠ˜æ‰£ `FULL`

  > æ»¡è¶³ä¸€å®šæ•°é‡ï¼Œæ‰æ”¯æŒæŠ˜æ‰£ï¼Œå¦‚ï¼šå¤Ÿä¹° N ä»¶ å…¶ä¸­ M ä»¶äº«å—ä¼˜æƒ  ğŸ”
  >
  > æ³¨æ„ï¼š
  >
  > **è¿™é‡Œçš„æ»¡å‡æŠ˜æ‰£æŒ‡çš„ä¸æ˜¯é‡‘é¢çš„æ»¡å‡ï¼Œè€Œæ˜¯å•†å“æ•°é‡çº§åˆ«çš„æ»¡å‡**

  ğŸŒ°ï¼š

  ğŸŸ æ»¡ 3 ä»¶ï¼Œå…¶ä¸­ 1 ä»¶äº”æŠ˜

  - è´­ä¹° 2 ä»¶ï¼Œå‡åŸä»·
  - è´­ä¹° 3 ä»¶ï¼Œ1 ä»¶äº”æŠ˜ï¼Œ2 ä»¶åŸä»·
  - è´­ä¹° 10 ä»¶ï¼Œ1 ä»¶äº”æŠ˜ï¼Œ9 ä»¶åŸä»·

- æ¯è´­ä¹° N ä»¶ï¼Œå…¶ä¸­ M ä»¶äº«æŠ˜æ‰£ `EVERY_FULL`

  > è¿™ä¸ªåœºæ™¯å°±ç›¸å¯¹å¤æ‚ä¸€ç‚¹ã€‚

  ğŸŒ°ï¼š

  ğŸ” æ¯æ»¡ 3 ä»¶ï¼Œå…¶ä¸­ 2 ä»¶äº«äº”æŠ˜ã€‚

  - è´­ä¹° 2 ä»¶ï¼Œåˆ™å‡åŸä»·
  - è´­ä¹° 3 ä»¶ï¼Œ2 ä»¶äº”æŠ˜ï¼Œ1 ä»¶åŸä»·
  - è´­ç‰© 5 ä»¶ï¼Œ2 ä»¶äº”æŠ˜ï¼Œ1 ä»¶åŸä»·
  - è´­ä¹° 7 ä»¶ï¼Œ4 ä»¶äº”æŠ˜ï¼Œ3 ä»¶åŸä»·

## æ ¸å¿ƒå‚æ•°

è¿™é‡Œæˆ‘ä»¬ä»¥å°ç¨‹åºè§†è§’æ¥çœ‹ï¼š

![image-20231225094555009](https://image.jimmyxuexue.top/img/202312250946821.png)

å•†å“æ‰€æœ‰çš„æ•°æ®å‡æ¥æºäºå°ç¨‹åºç«¯çš„`store/product/mini/query`è¿™ä¸ªæ¥å£ï¼Œæ´»åŠ¨ä¿¡æ¯å­˜æ”¾åœ¨ activitys è¿™ä¸ªæ•°ç»„ä¸­ã€‚

> è™½ç„¶æ˜¯æ•°ç»„ï¼Œä½†æ˜¯è¿™å—å¥½åƒæ˜¯åªä¼šè¿”å›ä¸€æ¡æ•°æ®ï¼Œå› ä¸ºä¸€ä¸ªå•†å“åªä¼šäº«å—ä¸€ä¸ªæ´»åŠ¨ã€‚

å…¶ä¸­æœ€ä¸ºå…³é”®çš„æ•°æ®æ˜¯`activityId`å’Œ`extJson`å­—æ®µã€‚

`activityId`è¿™ä¸ªå­—æ®µç”¨äºåˆ¤æ–­è¿™ä¸ªå•†å“æ˜¯å¦æ‰€å±äºå“ªä¸ªæ´»åŠ¨ã€‚

> ä¸åŒçš„å•†å“å¯ä»¥å…±äº«åŒä¸€ä¸ªæ´»åŠ¨

ğŸŒ°ï¼š

ğŸ”å’ŒğŸŸéƒ½å…±åŒå‚ä¸æ»¡äºŒï¼Œå…¶ä¸­ä¸€ä»¶åŠä»·çš„æ´»åŠ¨ã€‚æ‰€ä»¥è¿™æ—¶æ—¶å€™åªè¦è¿™ä¹ˆæƒ…å†µå°±å¯ä»¥è§¦å‘è¿™ä¸ªæ´»åŠ¨ï¼š

- ä¸¤ä¸ªğŸ”
- ä¸¤ä¸ªğŸŸ
- ä¸€ä¸ªğŸ”å’Œä¸€ä¸ªğŸŸ

****

`extJson` è¿™ä¸ªå­—æ®µï¼Œå…¶è¿”å›çš„æ˜¯ä¸€ä¸ªJSONåŒ–çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨`JSON.parse`å¤„ç†ä¸€ä¸‹ã€‚

> qï¼šä¸ºå•¥è¦è¿™æ ·è®¾è®¡ï¼Ÿæ˜¯ä¸ºäº†æ•°æ®é‡å°ä¸€ç‚¹åŠ å¿«è¯·æ±‚é€Ÿåº¦å—ï¼Ÿ

è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªè¿˜æ˜¯ç›¸å¯¹å¤§çš„æ•°æ®ï¼š

```ts
{"activityCanBuyTotal":2147483647,"addPriceFlag":false,"channel":"1,3,2","cornerMark":null,"cornerMarkBackgroundColor":null,"cornerMarkFlag":false,"cornerMarkFontColor":null,"discountConditionType":"STRAIGHT_AT","discountConditionValue":1,"joinActivityLimit":null,"joinDayLimit":5,"originalPrice":null,"originalPriceFlag":true,"price":33.80,"priceSort":"","priceType":"SPECIAL_PRICE","productLimit":"SINGLE","productQuantityLimit":5,"showActivityPrice":33.80,"todayCanBuyTotal":5,"userType":"CARD"}
```

è§£æåå¾—åˆ°è¿™ä¹ˆä¸€ä¸²æ•°æ®ï¼š

```ts
{
    "activityCanBuyTotal":2147483647, // æ´»åŠ¨çš„å•†å“æ€»æ•°é‡
    "addPriceFlag":false, // åŠ æ–™æ˜¯å¦ç®—è¿›ä¼˜æƒ 
    "channel":"1,3,2",
    "cornerMark":null,
    "cornerMarkBackgroundColor":null,
    "cornerMarkFlag":false,
    "cornerMarkFontColor":null,
    "discountConditionType":"STRAIGHT_AT", // æŠ˜æ‰£ç±»å‹
    "discountConditionValue":1,
    "joinActivityLimit":null,
    "joinDayLimit":5,
    "originalPrice":null,
    "originalPriceFlag":true,
    "price":33.8,
    "priceSort":"ASC", // å•†å“æ’åºçš„é¡ºåº
    "priceType":"SPECIAL_PRICE",
    "productLimit":"SINGLE", // æ´»åŠ¨æ˜¯å¦æ”¯æŒè·¨å•†å“
    "productQuantityLimit":5, // å•†å“å¯äº«å—çš„æ•°é‡
    "showActivityPrice":33.8,
    "todayCanBuyTotal":5, // ç”¨æˆ·å½“å¤©æœ€å¤šå¯ä»¥ä¹°çš„æ•°é‡
    "userType":"CARD"
}
```

è¿™é‡Œæœ€ä¸ºå…³é”®çš„æ˜¯è¿™ä¹ˆå…­ä¸ªå­—æ®µï¼š

- discountConditionType

  å•†å“æ´»åŠ¨ç±»å‹ï¼šé™æ—¶æŠ˜æ‰£ã€Nå‡æŠ˜æ‰£

  > ä¸Šé¢è¯¦ç»†ä»‹ç»è¿‡ï¼Œè¿™é‡Œä¸è¿‡è¿‡å¤šä»‹ç»

- productLimit

  å•†å“é™åˆ¶ï¼š"SINGLE"||"MULTI"

  å•†å“æ´»åŠ¨æ˜¯å¦æ”¯æŒè·¨å•†å“

  > å½“ğŸ”å’ŒğŸŸéƒ½æ”¯æŒ5æŠ˜æ´»åŠ¨ã€‚ä¸”æ»¡3å‡ï¼Œå…¶ä¸­2ä»¶å‚ä¸äº’åŠ¨

  - SINGLE

    åªæœ‰è‡³å°‘3ä»¶ğŸ”ï¼Œæˆ–è€…3ä»¶ğŸŸæ‰èƒ½æ»¡è¶³æ´»åŠ¨ï¼Œå¦‚æœ1ä¸ªğŸ”ä¸¤ä¸ªğŸŸæ˜¯ä¸èƒ½äº«å—æ´»åŠ¨çš„ã€‚

  - MULTI

    ğŸ”æˆ–è€…ğŸŸï¼Œåªè¦äºŒè€…åŠ èµ·æ¥æœ‰3ä»¶å°±å¯ä»¥å‚ä¸æ´»åŠ¨ã€‚å¦‚1ä¸ªğŸ”å’Œ2ä¸ªğŸŸã€‚

- priceSort

  ä»·æ ¼æ’åºï¼š"ASC"||"DESC"

  > å½“ğŸ”(10å…ƒ)å’ŒğŸŸ(7å…ƒ)éƒ½äº«å—è¿™ä¸ªæ´»åŠ¨æ—¶ï¼Œè¿™æ—¶å€™åˆ°åº•ç”¨å“ªä¸ªå•†å“å‚ä¸æ´»åŠ¨å‘¢ï¼Ÿå°±æ˜¯æ ¹æ®è¿™ä¸ªå­—æ®µè¿›è¡Œå†³å®šçš„

  - ASC

    ä»é«˜åˆ°åº•å‚ä¸æ´»åŠ¨ã€‚åˆ™æ­¤æ—¶ğŸ”å‚ä¸æ´»åŠ¨

  - DESC

    ä»ä½åˆ°é«˜å‚ä¸æ´»åŠ¨ã€‚åˆ™æ­¤æ—¶ğŸŸå‚ä¸æ´»åŠ¨

- addPriceFlag

  åŠ æ–™æ˜¯å¦ç®—è¿›ä¼˜æƒ 

  > è¿™ä¸ªæ˜¯ç»™å…¶ä»–å“ç‰Œæ‰“å·¥çš„å­—æ®µ~ æˆ‘ä»¬æ¶‰åŠçš„åŠ æ–™çš„å¥½åƒåªæœ‰ä¸€ä¸¤å®¶é—¨åº—ã€‚

  ğŸŒ°ï¼š

  ä¸€æ¯æ™®é€šå¥¶èŒ¶ï¼ˆ10å…ƒï¼‰å¯ä»¥åŠ å°æ–™ï¼Œå¦‚ï¼š+çç ï¼ˆ2å…ƒï¼‰ã€+æ¤°æœï¼ˆ3å…ƒï¼‰ã€+èŠ‹åœ†ï¼ˆ3å…ƒï¼‰ã€‚

  å¥¶èŒ¶è®¾ç½®äº†ç‰¹ä»·äº”æŠ˜çš„æ´»åŠ¨ã€‚

  - å½“åŠ æ–™ç®—è¿›ä¼˜æƒ 
    - å¥¶èŒ¶ = 10/2 = 5
    - å¥¶èŒ¶+çç  = (10+2)/2 = 6
    - å¥¶èŒ¶+çç +æ¤°æœ = (10+2+3)/2 = 7.5
  - å½“åŠ æ–™ä¸ç®—è¿›ä¼˜æƒ 
    - å¥¶èŒ¶ = 10/2 = 5
    - å¥¶èŒ¶+çç  = (10/2)+2 = 7
    - å¥¶èŒ¶+çç +æ¤°æœ = (10/2)+2+3 = 10

- productQuantityLimit

  å•†å“å¯å‚ä¸æ´»åŠ¨çš„é™åˆ¶

  ğŸ”æœ‰5æŠ˜é™æ—¶æŠ˜æ‰£æ´»åŠ¨ã€‚

  å¦‚è¿™ä¸ªé™åˆ¶æ˜¯5ï¼Œåˆ™å°±ç®—æ˜¯é™æ—¶æŠ˜æ‰£æ´»åŠ¨ï¼Œå°±ç®—åŠ è´­äº†10ä¸ªğŸ”ï¼Œæœ€å¤šä¹Ÿåªæœ‰5ä¸ªğŸ”èƒ½å¤Ÿå‚ä¸æ´»åŠ¨ã€‚

- todayCanBuyTotal

  å¯¹äºç”¨æˆ·è§’åº¦ï¼Œä»Šå¤©è¿˜å¯ä»¥äº«å—çš„æ´»åŠ¨æ¬¡æ•°ã€‚

  > ä¸ productQuantityLimit è§£æç±»ä¼¼

- activityCanBuyTotal

  å¯¹è¿™ä¸ªæ´»åŠ¨æ€»å…±å¯ä»¥å–çš„ğŸ”æ•°é‡ã€‚

ä»¥ä¸Šçš„å­—æ®µå•ç‹¬æ¥çœ‹æœ‰çš„å°±æœ‰ä¸€äº›å¤æ‚äº†ï¼Œä½†æ˜¯ä»–ä»¬å¦‚æœç»„åˆèµ·æ¥ï¼Œé‚£ä¸ªå®ƒçš„æ€»ä½“æ´»åŠ¨å°±æœºåˆ¶å¤æ‚äº†ã€‚

æ ¸å¿ƒè®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š

> ç»´æŠ¤ä¸€ä¸ª ActivityMapï¼Œkey: cartItem.id value: å¯å‚ä¸æ´»åŠ¨çš„æ•°é‡

```ts
export let ActivityMap: { [key in string]: number } = {}

export function clearActivityMap() {
  ActivityMap = {}
}
```

1. è·å–è´­ç‰©è½¦ä¸­ç›¸åŒç±»å‹å•†å“çš„æ•°é‡ `getSameTypeCartItems`

2. è·å–æ¯ä¸ªé¡¹å¯å‚ä¸æ´»åŠ¨çš„æ•°é‡

   > è¿™ä¸€å—çš„å¤„ç†å‰ç«¯æ˜¯æ¯”åç«¯æ›´å¤æ‚çš„ï¼Œå¦‚+çç å’Œå¥¶èŒ¶å’Œ+æ¤°æœçš„å¥¶èŒ¶ï¼Œåœ¨å‰ç«¯çš„è´­ç‰©è½¦ä¸­æ˜¯ä¸¤é¡¹ï¼Œè€Œå¯¹äºåç«¯æ¥è¯´æ˜¯åŒä¸€ä¸ªå•†å“ã€‚

   ![image-20231225152022224](https://image.jimmyxuexue.top/img/202312251520272.png)

3. è®¡ç®—é‡‘é¢

### å°è¯•ç‰›åˆ€ï¼š

> äº†è§£äº†å­—æ®µä¹‹åï¼Œæˆ‘ä»¬æ¥å°çœ‹ä¸€ä¸ªğŸŒ°ï¼Œä¸€èµ·æ¥è®¡ç®—ä¸‹ï¼Œçœ‹çœ‹ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„åœºæ™¯åº”è¯¥æ€ä¹ˆç®—ã€‚

ğŸŒ°ï¼š

ğŸ”ï¼ˆ10å…ƒï¼‰æ”¯æŒï¼ˆ+åŠ è‚‰é¥¼5å…ƒï¼‰å’ŒğŸŸï¼ˆ8å…ƒï¼‰æ”¯æŒï¼ˆ+10æ ¹3å…ƒï¼‰éƒ½å‚ä¸æ¯æ»¡3ä»¶å…¶ä¸­2ä»¶5æŠ˜çš„æ´»åŠ¨ï¼Œä¸”æœ€å¤šä¸€ä¸ªåªèƒ½5ä¸ªå•†å“äº«å—ï¼Œæ­¤æ—¶è´­ç‰©è½¦åŠ è´­äº†4ä¸ªğŸ”ï¼Œ4ä¸ªğŸŸã€‚

# åå°ç›¸å…³

æ´»åŠ¨ç›¸å…³çš„é…ç½®åœ¨ï¼šè¥é”€ => æå‡å®¢å• => é™æ—¶æŠ˜æ‰£||è´­Nä»¶äº«æŠ˜æ‰£

![image-20231225144928486](https://image.jimmyxuexue.top/img/202312251449596.png)

å…¶ä¸­ç›¸å…³é…ç½®å‡åœ¨æ­¤å¤„è¿›è¡Œè®¾ç½®ï¼š

![image-20231225150309742](https://image.jimmyxuexue.top/img/202312251503774.png)
